<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Rails with postgresql views by leveraging active record entity models</h1><p class="page-description">Rails + postgresql views/materialized views with versioning and usages</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-09-15T00:00:00-05:00" itemprop="datePublished">
        Sep 15, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#postgres">postgres</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#rails">rails</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#views">views</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#rails-with-postgresql-views-by-leveraging-active-record-entity-models">Rails with postgresql views by leveraging active record entity models</a>
<ul>
<li class="toc-entry toc-h2"><a href="#problem-statement">Problem Statement</a></li>
<li class="toc-entry toc-h2"><a href="#initial-implementation-of-reports-in-ruby">Initial implementation of reports in ruby</a></li>
<li class="toc-entry toc-h2"><a href="#working-with-postgres-views">Working with postgres views</a>
<ul>
<li class="toc-entry toc-h4"><a href="#logical-views">Logical Views</a></li>
<li class="toc-entry toc-h4"><a href="#materialized-views">Materialized Views</a></li>
<li class="toc-entry toc-h4"><a href="#scenic-view">Scenic view</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#we-have-gone-from-780sec-to-3secs">                We have gone from 780sec to 3secs</a></li>
</ul>
</li>
</ul><h1 id="rails-with-postgresql-views-by-leveraging-active-record-entity-models">
<a class="anchor" href="#rails-with-postgresql-views-by-leveraging-active-record-entity-models" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rails with postgresql views by leveraging active record entity models</h1>

<h2 id="problem-statement">
<a class="anchor" href="#problem-statement" aria-hidden="true"><span class="octicon octicon-link"></span></a>Problem Statement</h2>

<p>We had a use case where we had to generate a report in an existing meeting scheduler system. This report shows all the data of the report around the meeting.</p>

<p>While showing the report it involves the most complex logic based on role, meetings, meeting attendees, meeting customer information, meeting notes that are being captured. There are around 20+ filters present around the reports.</p>

<p>We had to expose an endpoint which gives back information in a format of attendee and respective meeting. It could be csv, excel or any other format.</p>

<p><img src="../images/rails_db_views/db_views_schema.png" height="300px" width="480px"></p>

<h2 id="initial-implementation-of-reports-in-ruby">
<a class="anchor" href="#initial-implementation-of-reports-in-ruby" aria-hidden="true"><span class="octicon octicon-link"></span></a>Initial implementation of reports in ruby</h2>

<p>Initially we have decide to implement all reportings in ruby. The naive approach will include initializing each object and associated objects to the meeting.</p>

<p>This worked well initially for small amount of data. We have encountered performance issues when there are more than 2K meetings and each meeting has approximately 10. Which eventually become 21K objects initialization and storing the data in-memory while processing all of them.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">bm</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="p">.</span><span class="nf">report</span> <span class="p">{</span>
  <span class="no">MeetingRequest</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">meeting_request</span><span class="o">|</span>
    <span class="n">meeting_request_details</span> <span class="o">=</span> <span class="n">meeting_request</span><span class="p">.</span><span class="nf">meeting_meta_reports_on_demand</span><span class="p">(</span><span class="n">mm_role_uuid</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">' || '</span><span class="p">,</span> <span class="p">{</span><span class="ss">template_mode: </span><span class="s2">"separated"</span><span class="p">})</span>
  <span class="k">end</span>
<span class="p">}</span> <span class="p">}</span>
 <span class="c1">#      user     system      total        real</span>
 <span class="c1">#    444.780000  12.660000 457.440000 (780.303877)</span>
 <span class="c1"># =&gt; [#&lt;Benchmark::Tms:0x000000001ba8cc88 @label="", @real=780.3038765005767, @cstime=0.0, @cutime=0.0, @stime=12.66, @utime=444.78000000000003, @total=457.44000000000005&gt;]</span>
</code></pre></div></div>

<p>It takes 10 seconds to retrieve the data and to format it. In a real life scenario, we would have to account for the time needed for the request to go through all the stack, from routing to rendering the views. 10 seconds is a lot of time, especially if you have lots of requests coming.</p>

<p>It starts taking more than 60 seconds if the request is having heavy data to manipulate and request.</p>

<h2 id="working-with-postgres-views">
<a class="anchor" href="#working-with-postgres-views" aria-hidden="true"><span class="octicon octicon-link"></span></a>Working with postgres views</h2>

<blockquote>
  <p><em>                Database view is named query that provides another way to present data in the database tables. A view is defined based on one or more tables which are known as base tables. When you create a view, you basically create a query and assign it a name, therefore a view is useful for wrapping a commonly used complex query.</em></p>
</blockquote>

<p>Postgres has different types of views which are present.</p>
<ul>
  <li>Logical Views</li>
  <li>Materialized views</li>
</ul>

<h4 id="logical-views">
<a class="anchor" href="#logical-views" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Logical Views</strong>
</h4>

<p>                They evaluate the data in the tables underlying the view definition at the time the view is queried. It is a logical view of your tables, with no data stored anywhere else.</p>

<p>                The upside of a view is that it will always return the latest data to you. The downside of a view is that its performance depends on how good a select statement the view is based on. If the select statement used by the view joins many tables, or uses joins based on non-indexed columns, the view could perform poorly.</p>

<h4 id="materialized-views">
<a class="anchor" href="#materialized-views" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Materialized Views</strong>
</h4>

<p>They are similar to regular views, in that they are a logical view of your data (based on a select statement), however, the underlying query result set has been saved to a table. The upside of this is that when you query a materialized view, you are querying a table, which may also be indexed. (<a href="https://stackoverflow.com/questions/93539/what-is-the-difference-between-views-and-materialized-views-in-oracle">source</a>)
<br></p>
<blockquote>
  <p>Given the fact that we will have a lot of updates at ongoing events and meeting managers expect the reports in real time without any stale data we have decided to go with logical views than materialized views.</p>
</blockquote>

<h4 id="scenic-view">
<a class="anchor" href="#scenic-view" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Scenic view</strong>
</h4>

<p>                I have decided to go with (scenic gem)[https://github.com/scenic-views/scenic] considering convention for versioning views that keeps migration history consistent and reversible and avoids having to duplicate SQL strings across migrations</p>

<ul>
  <li><strong>Creating a scenic view</strong></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="err">$</span> <span class="n">rails</span> <span class="n">generate</span> <span class="n">scenic</span><span class="ss">:view</span> <span class="n">meeting</span>
<span class="no">Initializing</span> <span class="n">plugins</span><span class="o">...</span>
      <span class="n">create</span>  <span class="n">db</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">meetings_v01</span><span class="p">.</span><span class="nf">sql</span>
      <span class="n">create</span>  <span class="n">db</span><span class="o">/</span><span class="n">migrate</span><span class="o">/</span><span class="mi">20180916125309</span><span class="n">_create_meetings</span><span class="p">.</span><span class="nf">rb</span>
</code></pre></div></div>

<p>                Meeting View can be used as usal active record model and levarage all the functionalities at the same isolate the SQL queries in migration.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Model</span>
<span class="k">class</span> <span class="nc">MeetingView</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="ss">:meeting_uuid</span><span class="p">,</span> <span class="ss">:invite_user_uuid</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># [timestamp]_create_meetings.rb</span>
<span class="no">SELECT</span>
  <span class="n">meeting_requests</span><span class="p">.</span><span class="nf">id</span> <span class="no">AS</span> <span class="n">meeting_id</span><span class="p">,</span>
  <span class="n">meeting_requests</span><span class="p">.</span><span class="nf">uuid</span> <span class="no">AS</span> <span class="n">meeting_uuid</span><span class="p">,</span>
  <span class="n">meeting_requests</span><span class="p">.</span><span class="nf">meeting_with</span> <span class="n">as</span> <span class="n">meeting_with</span><span class="p">,</span>
  <span class="o">...</span>
  <span class="o">...</span>
  <span class="o">...</span>
  <span class="no">FROM</span> <span class="n">meeting_requests</span>
<span class="no">LEFT</span> <span class="no">JOIN</span> <span class="n">rooms</span> <span class="no">ON</span> <span class="n">rooms</span><span class="p">.</span><span class="nf">id</span> <span class="o">=</span> <span class="n">meeting_requests</span><span class="p">.</span><span class="nf">room_id</span>
<span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="n">topics</span> <span class="no">ON</span> <span class="n">topics</span><span class="p">.</span><span class="nf">id</span> <span class="o">=</span> <span class="n">meeting_requests</span><span class="p">.</span><span class="nf">topic_id</span>
    <span class="o">...</span>
    <span class="o">...</span>
<span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="n">requestor</span> <span class="no">ON</span> <span class="n">requestor</span><span class="p">.</span><span class="nf">uuid</span> <span class="o">=</span> <span class="n">meeting_requests</span><span class="p">.</span><span class="nf">requestor_uuid</span>
</code></pre></div></div>

<p>                We have bench makred same format of the response format and see a major shift in the time that it takes to prepare the data to export. Please check the below report</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">bm</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="p">.</span><span class="nf">report</span> <span class="p">{</span>
  <span class="n">meetings</span><span class="p">,</span> <span class="n">te</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="no">MeetingView</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">sort_and_grouping</span><span class="p">({}.</span><span class="nf">merge</span><span class="p">({</span><span class="ss">current_location: </span><span class="n">location</span><span class="p">}))</span>
  <span class="n">settings</span> <span class="o">=</span> <span class="no">MeetingViewUtils</span><span class="o">::</span><span class="no">Settings</span><span class="p">.</span><span class="nf">get_options</span><span class="p">(</span><span class="n">meetings</span><span class="p">,</span> <span class="p">{}.</span><span class="nf">merge</span><span class="p">({</span><span class="ss">current_location: </span><span class="n">location</span><span class="p">}));</span><span class="mi">0</span>
  <span class="n">meeting_objs</span> <span class="o">=</span> <span class="no">MeetingViewUtils</span><span class="o">::</span><span class="no">MergedMeetingViewSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">meetings</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">current_event</span><span class="p">).</span><span class="nf">ondemand_attribs</span>
<span class="p">}</span> <span class="p">}</span>

<span class="c1">#       user     system      total        real</span>
<span class="c1">#    0.220000   0.000000   0.220000 (  3.059728)</span>
<span class="c1"># =&gt; [#&lt;Benchmark::Tms:0x000000002de13138 @label="", @real=3.059727756306529, @cstime=0.0, @cutime=0.0, @stime=0.0, @utime=0.22000000000002728, @total=0.22000000000002728&gt;]</span>
</code></pre></div></div>
<p><br></p>
<h2 id="we-have-gone-from-780sec-to-3secs">
<a class="anchor" href="#we-have-gone-from-780sec-to-3secs" aria-hidden="true"><span class="octicon octicon-link"></span></a>                <strong>We have gone from 780sec to 3secs</strong>
</h2>

<p><br>
                As expected, DB Views approach is <strong>260 times faster</strong> than the naive ruby approach. If we have proper indexes for tables on what we are querying then it will be way faster. We are in the process of establishing the proper indexes and db scans while writing a scenic view so that it can improve a lot more.</p>

<p><br><br>
<strong>I’m happy to answer any questions if there are any! HMU in the comments.</strong></p>

  </div>

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://iamurali.github.io/2020-09-15-rails-postgres-views/';
      this.page.identifier = 'https://iamurali.github.io/2020-09-15-rails-postgres-views/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://iamurali.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<a class="u-url" href="/2020-09-15-rails-postgres-views/" hidden></a>
</article>


  

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://iamurali.github.io/2020-09-15-rails-postgres-views/';
      this.page.identifier = 'https://iamurali.github.io/2020-09-15-rails-postgres-views/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://iamurali.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

