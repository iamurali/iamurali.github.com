<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Template Rendering with Dynamic context | Murali Kummitha Software Engineer</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Template Rendering with Dynamic context" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Parse the erb template string and make use of binding to encapsulate the current context for parsing." />
<meta property="og:description" content="Parse the erb template string and make use of binding to encapsulate the current context for parsing." />
<link rel="canonical" href="https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/" />
<meta property="og:url" content="https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/" />
<meta property="og:site_name" content="Murali Kummitha Software Engineer" />
<meta property="og:image" content="https://iamurali.github.io/images/erb-context.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-15T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Parse the erb template string and make use of binding to encapsulate the current context for parsing.","@type":"BlogPosting","url":"https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/","dateModified":"2020-08-15T00:00:00-05:00","datePublished":"2020-08-15T00:00:00-05:00","headline":"Template Rendering with Dynamic context","image":"https://iamurali.github.io/images/erb-context.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://iamurali.github.io/feed.xml" title="Murali Kummitha | Software Engineer" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-175466210-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Template Rendering with Dynamic context | Murali Kummitha Software Engineer</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Template Rendering with Dynamic context" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Parse the erb template string and make use of binding to encapsulate the current context for parsing." />
<meta property="og:description" content="Parse the erb template string and make use of binding to encapsulate the current context for parsing." />
<link rel="canonical" href="https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/" />
<meta property="og:url" content="https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/" />
<meta property="og:site_name" content="Murali Kummitha Software Engineer" />
<meta property="og:image" content="https://iamurali.github.io/images/erb-context.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-15T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Parse the erb template string and make use of binding to encapsulate the current context for parsing.","@type":"BlogPosting","url":"https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/","dateModified":"2020-08-15T00:00:00-05:00","datePublished":"2020-08-15T00:00:00-05:00","headline":"Template Rendering with Dynamic context","image":"https://iamurali.github.io/images/erb-context.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://iamurali.github.io/feed.xml" title="Murali Kummitha | Software Engineer" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-175466210-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Murali Kummitha | Software Engineer</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Template Rendering with Dynamic context</h1><p class="page-description">Parse the erb template string and make use of binding to encapsulate the current context for parsing.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-08-15T00:00:00-05:00" itemprop="datePublished">
        Aug 15, 2020
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#ruby">ruby</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#erb">erb</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#yml">yml</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#templating">templating</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#rails">rails</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#ROR">ROR</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#template-rendering-with-dynamic-context">Template Rendering with Dynamic context</a>
<ul>
<li class="toc-entry toc-h2"><a href="#problem-statement">Problem Statement</a></li>
</ul>
</li>
</ul><h1 id="template-rendering-with-dynamic-context">
<a class="anchor" href="#template-rendering-with-dynamic-context" aria-hidden="true"><span class="octicon octicon-link"></span></a>Template Rendering with Dynamic context</h1>

<h2 id="problem-statement">
<a class="anchor" href="#problem-statement" aria-hidden="true"><span class="octicon octicon-link"></span></a>Problem Statement</h2>
<p>In one of projects when we had to build a service to generate history for a particular entity if there are changes occurs. we had to build a template engine which can translate the entity changes in humar redable format.</p>

<p>Formatting text as YAML:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">entity</span><span class="pi">:</span> <span class="s">Event</span>
    <span class="s">- changes</span><span class="pi">:</span> 
        <span class="na">from</span><span class="pi">:</span> <span class="s">2020-08-15</span>
        <span class="na">to</span><span class="pi">:</span> <span class="s">2020-08-17</span>
<span class="pi">-</span> <span class="na">expected_format</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Event</span><span class="nv"> </span><span class="s">rescheduled</span><span class="nv"> </span><span class="s">event</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">Aug</span><span class="nv"> </span><span class="s">15th</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Augh</span><span class="nv"> </span><span class="s">17th</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">bob</span><span class="nv"> </span><span class="s">(Current</span><span class="nv"> </span><span class="s">User)"</span>
</code></pre></div></div>

<p>Solution:</p>

<p>We have utilized the concept of <code class="highlighter-rouge">Binding</code> class able to encapsulate <strong>execution context</strong> of the receiver object.</p>

<p>For simplicity we chose ERB, we can place them within locale files for internationalisation and can be edit them with ease if need arises.</p>

<p>Since we extend <code class="highlighter-rouge">OpenStruct</code> we can simply pass a hash to it during instantiation and all the keys will be accessible as methods and will be exposed directly during rendering.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'erb'</span>
<span class="nb">require</span> <span class="s1">'ostruct'</span>

<span class="kp">include</span> <span class="no">ERB</span><span class="o">::</span><span class="no">Util</span>

<span class="k">module</span> <span class="nn">AuditMessage</span>
  <span class="k">class</span> <span class="nc">ErbTemplate</span> <span class="o">&lt;</span> <span class="no">OpenStruct</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
      <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">current_user</span>
      <span class="c1"># ===&gt; Fetch current user</span>
      <span class="n">user_id</span><span class="p">,</span> <span class="n">user_type</span> <span class="o">=</span> <span class="nb">self</span><span class="p">[</span><span class="ss">:_audit</span><span class="p">].</span><span class="nf">user_id</span><span class="p">,</span> <span class="nb">self</span><span class="p">[</span><span class="ss">:_audit</span><span class="p">].</span><span class="nf">user_type</span>
      <span class="n">user_type</span><span class="p">.</span><span class="nf">classify</span><span class="p">.</span><span class="nf">constantize</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">rescue</span>
      <span class="nb">self</span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">system_user</span>
      <span class="no">OpenStruct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"System User"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get_old_value</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
      <span class="c1"># ===&gt; Try to fetch the old value from the audit </span>
      <span class="c1">#  {"field": ["old_value", "new_value"]}</span>
      <span class="n">get_value</span><span class="p">(</span><span class="nb">self</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get_new_value</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
      <span class="c1"># ===&gt; Try to fetch the old value from the audit </span>
      <span class="c1">#  {"field": ["old_value", "new_value"]}</span>
      <span class="n">get_value</span><span class="p">(</span><span class="nb">self</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="s2">"new_value"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="nb">respond_to?</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span> <span class="p">?</span> <span class="nb">self</span><span class="p">[</span><span class="nb">method</span><span class="p">]</span> <span class="p">:</span> <span class="nb">self</span><span class="p">[</span><span class="ss">:_auditable</span><span class="p">].</span><span class="nf">send</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default_data</span><span class="o">=</span><span class="s2">"old_value"</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span>
      <span class="k">return</span> <span class="nb">send</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">unless</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">default_data</span> <span class="o">==</span> <span class="s2">"old_value"</span> <span class="p">?</span> <span class="n">value</span><span class="p">.</span><span class="nf">first</span> <span class="p">:</span> <span class="n">value</span><span class="p">.</span><span class="nf">last</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In the above example we have used ERB templating engine for parsing the text that we wanted with binding of current context.</p>

<p>We added extra methods like current_user who has changed the entity. This particular methods can be available through the context which can be used for back trace or additional info to be passed.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">entity</span><span class="pi">:</span>
    <span class="na">event</span><span class="pi">:</span> 
        <span class="na">update</span><span class="pi">:</span>
            <span class="na">message</span><span class="pi">:</span> <span class="pi">&gt;-</span>
            <span class="s">&lt;%= Event rescheduled event from #{format(old_value)} to #{format(old_value)} by #{current_user.name}" (Current User) %&gt;</span>
</code></pre></div></div>

<p>If we try to this particular example engine will look for the enity event and update action and generate custom message with the template passed to the parser. It tries to find the methods in the context of the current entity if there are any.</p>

<p>The benefit of creating a separate abstraction is that it creates a sandbox environment for the template processing. This allows us to have more control over what gets exposed during processing and prevents accidental leakages into the context.</p>

<p>The main method here is the render method, where we utilise the ERB library. We create an ERB instance with the supplied template string and then call result, to which we supply the current execution context using the current binding.</p>

<p>The usage would look something like this :</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Event</span>
    <span class="nb">attr_accessor</span> <span class="ss">:event_date</span>
<span class="k">end</span>
<span class="n">vars</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="ss">old_value: </span><span class="s2">"2020-08-15"</span><span class="p">,</span> 
    <span class="ss">new_value: </span><span class="s2">"2020-08-17"</span>
 <span class="p">}</span>
<span class="n">template_string</span> <span class="o">=</span> <span class="s2">"entity.</span><span class="si">#{</span><span class="n">klass_name</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">_action</span><span class="si">}</span><span class="s2">.message"</span>

<span class="no">AuditMessage</span><span class="o">::</span><span class="no">ErbTemplate</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">vars</span><span class="p">).</span><span class="nf">render</span><span class="p">(</span><span class="n">template_string</span><span class="p">)</span>
<span class="c1">#===&gt; result: "Event rescheduled event from Aug 15th to Augh 17th by bob (Current User)"</span>
</code></pre></div></div>

  </div>

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/';
      this.page.identifier = 'https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://iamurali.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<a class="u-url" href="/2020-08-15-dynamic-context-with-ruby/" hidden></a>
</article>


  

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/';
      this.page.identifier = 'https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://iamurali.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Technical blogs | ROR | Data Science | NLP | Python | Java | Databases</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/iamurali" title="iamurali"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/muralikummitha" title="muralikummitha"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
