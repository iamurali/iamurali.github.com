<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Template Rendering with Dynamic context</h1><p class="page-description">Parse the erb template string and make use of binding to encapsulate the current context for parsing.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-08-15T00:00:00-05:00" itemprop="datePublished">
        Aug 15, 2020
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#ruby">ruby</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#erb">erb</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#yml">yml</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#templating">templating</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#rails">rails</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#ROR">ROR</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#template-rendering-with-dynamic-context">Template Rendering with Dynamic context</a>
<ul>
<li class="toc-entry toc-h2"><a href="#problem-statement">Problem Statement</a></li>
</ul>
</li>
</ul><h1 id="template-rendering-with-dynamic-context">
<a class="anchor" href="#template-rendering-with-dynamic-context" aria-hidden="true"><span class="octicon octicon-link"></span></a>Template Rendering with Dynamic context</h1>

<h2 id="problem-statement">
<a class="anchor" href="#problem-statement" aria-hidden="true"><span class="octicon octicon-link"></span></a>Problem Statement</h2>
<p>In one of projects when we had to build a service to generate history for a particular entity if there are changes occurs. we had to build a template engine which can translate the entity changes in humar redable format.</p>

<p>Formatting text as YAML:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">entity</span><span class="pi">:</span> <span class="s">Event</span>
    <span class="s">- changes</span><span class="pi">:</span> 
        <span class="na">from</span><span class="pi">:</span> <span class="s">2020-08-15</span>
        <span class="na">to</span><span class="pi">:</span> <span class="s">2020-08-17</span>
<span class="pi">-</span> <span class="na">expected_format</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Event</span><span class="nv"> </span><span class="s">rescheduled</span><span class="nv"> </span><span class="s">event</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">Aug</span><span class="nv"> </span><span class="s">15th</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Augh</span><span class="nv"> </span><span class="s">17th</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">bob</span><span class="nv"> </span><span class="s">(Current</span><span class="nv"> </span><span class="s">User)"</span>
</code></pre></div></div>

<p>Solution:</p>

<p>We have utilized the concept of <code class="highlighter-rouge">Binding</code> class able to encapsulate <strong>execution context</strong> of the receiver object.</p>

<p>For simplicity we chose ERB, we can place them within locale files for internationalisation and can be edit them with ease if need arises.</p>

<p>Since we extend <code class="highlighter-rouge">OpenStruct</code> we can simply pass a hash to it during instantiation and all the keys will be accessible as methods and will be exposed directly during rendering.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'erb'</span>
<span class="nb">require</span> <span class="s1">'ostruct'</span>

<span class="kp">include</span> <span class="no">ERB</span><span class="o">::</span><span class="no">Util</span>

<span class="k">module</span> <span class="nn">AuditMessage</span>
  <span class="k">class</span> <span class="nc">ErbTemplate</span> <span class="o">&lt;</span> <span class="no">OpenStruct</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
      <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">current_user</span>
      <span class="c1"># ===&gt; Fetch current user</span>
      <span class="n">user_id</span><span class="p">,</span> <span class="n">user_type</span> <span class="o">=</span> <span class="nb">self</span><span class="p">[</span><span class="ss">:_audit</span><span class="p">].</span><span class="nf">user_id</span><span class="p">,</span> <span class="nb">self</span><span class="p">[</span><span class="ss">:_audit</span><span class="p">].</span><span class="nf">user_type</span>
      <span class="n">user_type</span><span class="p">.</span><span class="nf">classify</span><span class="p">.</span><span class="nf">constantize</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">rescue</span>
      <span class="nb">self</span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">system_user</span>
      <span class="no">OpenStruct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"System User"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get_old_value</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
      <span class="c1"># ===&gt; Try to fetch the old value from the audit </span>
      <span class="c1">#  {"field": ["old_value", "new_value"]}</span>
      <span class="n">get_value</span><span class="p">(</span><span class="nb">self</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get_new_value</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
      <span class="c1"># ===&gt; Try to fetch the old value from the audit </span>
      <span class="c1">#  {"field": ["old_value", "new_value"]}</span>
      <span class="n">get_value</span><span class="p">(</span><span class="nb">self</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="s2">"new_value"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="nb">respond_to?</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span> <span class="p">?</span> <span class="nb">self</span><span class="p">[</span><span class="nb">method</span><span class="p">]</span> <span class="p">:</span> <span class="nb">self</span><span class="p">[</span><span class="ss">:_auditable</span><span class="p">].</span><span class="nf">send</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default_data</span><span class="o">=</span><span class="s2">"old_value"</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">nil?</span>
      <span class="k">return</span> <span class="nb">send</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">unless</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">default_data</span> <span class="o">==</span> <span class="s2">"old_value"</span> <span class="p">?</span> <span class="n">value</span><span class="p">.</span><span class="nf">first</span> <span class="p">:</span> <span class="n">value</span><span class="p">.</span><span class="nf">last</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In the above example we have used ERB templating engine for parsing the text that we wanted with binding of current context.</p>

<p>We added extra methods like current_user who has changed the entity. This particular methods can be available through the context which can be used for back trace or additional info to be passed.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">entity</span><span class="pi">:</span>
    <span class="na">event</span><span class="pi">:</span> 
        <span class="na">update</span><span class="pi">:</span>
            <span class="na">message</span><span class="pi">:</span> <span class="pi">&gt;-</span>
            <span class="s">&lt;%= Event rescheduled event from #{format(old_value)} to #{format(old_value)} by #{current_user.name}" (Current User) %&gt;</span>
</code></pre></div></div>

<p>If we try to this particular example engine will look for the enity event and update action and generate custom message with the template passed to the parser. It tries to find the methods in the context of the current entity if there are any.</p>

<p>The benefit of creating a separate abstraction is that it creates a sandbox environment for the template processing. This allows us to have more control over what gets exposed during processing and prevents accidental leakages into the context.</p>

<p>The main method here is the render method, where we utilise the ERB library. We create an ERB instance with the supplied template string and then call result, to which we supply the current execution context using the current binding.</p>

<p>The usage would look something like this :</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Event</span>
    <span class="nb">attr_accessor</span> <span class="ss">:event_date</span>
<span class="k">end</span>
<span class="n">vars</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="ss">old_value: </span><span class="s2">"2020-08-15"</span><span class="p">,</span> 
    <span class="ss">new_value: </span><span class="s2">"2020-08-17"</span>
 <span class="p">}</span>
<span class="n">template_string</span> <span class="o">=</span> <span class="s2">"entity.</span><span class="si">#{</span><span class="n">klass_name</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">_action</span><span class="si">}</span><span class="s2">.message"</span>

<span class="no">AuditMessage</span><span class="o">::</span><span class="no">ErbTemplate</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">vars</span><span class="p">).</span><span class="nf">render</span><span class="p">(</span><span class="n">template_string</span><span class="p">)</span>
<span class="c1">#===&gt; result: "Event rescheduled event from Aug 15th to Augh 17th by bob (Current User)"</span>
</code></pre></div></div>

  </div>

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/';
      this.page.identifier = 'https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://iamurali.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<a class="u-url" href="/2020-08-15-dynamic-context-with-ruby/" hidden></a>
</article>


  

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/';
      this.page.identifier = 'https://iamurali.github.io/2020-08-15-dynamic-context-with-ruby/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://iamurali.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

